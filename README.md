# USB-polygon (embedded)

Программа на языке С для микроконтроллера AT90USB162

## Краткое описание

Часть радиолюбительского проекта с целью создания простого устройства на микроконтроллере, имеющего возможность подключения к компьютеру по USB. Проект описан в цикле статей по адресу <http://romeogolf.github.io/tag/usb-polygon.html>.

Подробности использования программы в рамках проекта описаны в статьях цикла. К коммитам добавлены теги вида "polygon-x", означающие, что данный коммит является результатом работы, описанной в статье "USB-polygon-x"

### Остальные части проекта:

* схема электрическая принципиальная и печатная плата устройства в KiCAD [(ссылка)](https://github.com/RomeoGolf/usb-polygon-kicad)
* программа на C++ для взаимодействия с устройством со стороны ПК [(ссылка)](https://github.com/RomeoGolf/usb-polygon-cpp)
* программа на С++ для опроса одного из "файлов" на устройстве в непрерывном режиме (с отключением буферизации данных на ПК) [(ссылка)](https://github.com/RomeoGolf/usb-polygon-read-loop)
* программа на С++ для подготовки кадров "циферблата", отображаемого на ЖК-экране [(ссылка)](https://github.com/RomeoGolf/usb-polygon-makedial)

## Начало работы

### Зависимости

Для компиляции и прошивки программы необходимо следующее программное обеспечение:

* [LUFA](http://www.fourwalledcubicle.com/LUFA.php)
* Cygwin (для Windows)
* Atmel AVR Toolchain [для Windows](http://www.atmel.com/tools/ATMELAVRTOOLCHAINFORWINDOWS.aspx) или [для Linux](http://www.atmel.com/tools/ATMELAVRTOOLCHAINFORLINUX.aspx)
* [FLIP](http://www.atmel.com/ru/ru/tools/flip.aspx "FLIP") или [dfu-programmer](http://dfu-programmer.github.io/)

### Получение

Для получения копии репозитория следует воспользоваться кнопкой "Clone or download" на [странице репозитория](https://github.com/RomeoGolf/usb-polygon-embedded).

При отсутствии git можно нажать кнопку "Download ZIP" и получить последнюю версию без истории коммитов.

При наличии git можно скопировать URL https://github.com/RomeoGolf/usb-polygon-embedded.git и использовать его в команде

~~~~
git clone https://github.com/RomeoGolf/usb-polygon-embedded.git
~~~~

в командной строке (git bash, например, в зависимости от ОС и настроек).

Следует создать папку проекта, например, `usb-polygon-embedded`, в нее следует поместить папку `LUFA` из библиотеки LUFA и папку `MassStorage`, содержащую файлы и папки исходного кода данной программы из репозитория.

### Компиляция

В ОС Windows следует в конце файла `C:\cygwin\home\<имя пользователя>\.bashrc` добавить строку, указывающую путь к AVR Toolchain:

```
export PATH=/cygdrive/<буква диска>/<путь к toolchain>/avr8-gnu-toolchain/bin:$PATH
```

Либо вводить данную команду вручную в начале каждого сеанса работы. Для компиляции следует в Cygwin terminal ввести команды:

```
$ cd /cygdrive/<буква диска>/<путь к проекту>/MassStorage/
$ make
```

### Прошивка

Для записи откомпилированной программы в память устройства можно воспользоваться утилитой FLIP, пользуясь справкой к данной утилите.

Кроме того, можно воспользоваться кроссплатформенной утилитой командной строки dfu-programmer. Для этого следует поместить папку с dfu-programmer.exe версии 0.7.2 на одном уровне с папкой проекта usb-polygon-embedded, затем, находясь в папке `MassStorage`, последовательно ввести в командной строке Windows (не в терминале Cygwin, можно воспользоваться файловым менеджером FAR) следующие команды:

```
..\..\dfu-programmer-win-0.7.2\dfu-programmer at90usb162 erase
..\..\dfu-programmer-win-0.7.2\dfu-programmer at90usb162 flash MassStorage.hex
..\..\dfu-programmer-win-0.7.2\dfu-programmer at90usb162 reset
```

Можно также подготовить CMD-файл с указанным набором команд, разместить его в папке `MassStorage` и запускать на выполнение по мере необходимости.

Прошивку следует выполнять, предварительно подключив устройство к ПК при помощи USB-кабеля.

### Запуск

Программа должна запуститься автоматически. Ее можно перезапустить нажатием кнопки Reset на устройстве, либо снятием и подачей питания путем извлечения и подключения USB-кабеля.

Контролировать правильность запуска можно по светодиодной индикации, по реакции ПК на подключенное устройство или по отображению на подключенном ЖК-экране, в зависимости от запускаемой версии программы.

## Развитие проекта

Дальнейшее развитие проекта не предполагается, так как цель достигнута.

## Лицензия

This project is licensed under the MIT License - see the [License.txt](License.txt) file for details

